---
name: "si_lsqml_exp"
backend: jax

# raw data source
raw_data:
  type: empad
  path: "~/raw-ptycho/Si-20230920/acq10_20over/acq10_20over_calib.json"

#post_load:
#  - type: crop_data
#    crop: [0, 100, 0, 100]

post_init:
  - drop_nans
  - diffraction_align

slices:
  n: 15
  total_thickness: 200

# for each reconstruction engine
engines:
   # how to transition from previous state to current reconstruction state
   # how to reconstruct
   # how to output/save
 - type: 'conventional'
   probe_modes: 4

   niter: 500
   grouping: 128
   bwlim_frac: 1.0

   noise_model:
     type: 'amplitude'
     eps: 3.0e+0

   solver:
     type: 'lsqml'
     beta_probe: 0.9
     beta_object: 1.0
     gamma: 0.1

     illum_reg_object: 50.0
     illum_reg_probe: 0.1

   position_solver:
     type: momentum
     momentum: 0.90
     step_size: 5.0e-2
     max_step_size: 0.2

   group_constraints:
     - type: limit_probe_support
       max_angle: 22.0
   iter_constraints:
     #- remove_phase_ramp
     - type: layers
       sigma: 100.0
       weight: 0.05
     - type: clamp_object_amplitude
       amplitude: 1.0

   update_probe: {after: 5}
   update_positions: {after: 5}
   #send_every_group: True

   save: {every: 10}
   save_images: {every: 10}
   save_options:
     images: [
      'probe', 'probe_recip', 'object_phase_sum', 'object_mag_sum',
      'object_phase_stack', 'object_mag_stack'
     ]